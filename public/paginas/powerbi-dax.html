<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power BI Masterclass: A Engenharia por Trás do DAX | DAnalise</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Fira+Code&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="page-styles.css">
    <style>
        .page-title-section.visualizacao-theme {
            background: var(--visualizacao-light);
            border-color: var(--visualizacao);
        }

        .content-section h2 {
            color: var(--visualizacao);
            border-color: var(--visualizacao-light);
        }

        .back-link:hover {
            color: var(--visualizacao);
        }

        .step-list li::before {
            background: var(--visualizacao);
        }

        .table-example th {
            background: var(--visualizacao);
            color: #111;
        }

        .formula-display {
            color: var(--visualizacao);
        }

        .nav-bottom a:hover {
            border-color: var(--visualizacao);
        }
    </style>
    <link rel="icon" href="../assets/logo-circle.png" type="image/png">
</head>

<body>
    <div id="subpage-theme-toggle" class="theme-toggle"
        style="position: absolute; top: 2rem; right: 2rem; z-index: 100;">
        <img id="theme-icon-img" src="../assets/moon-white.png" alt="Alternar Tema" style="width: 20px; height: 20px;">
    </div>
    <main class="content-page">
        <a href="../index.html#visualizacao" class="back-link">[<] Voltar para Modulo 3 - Visualizacao</a>

                <div class="page-title-section visualizacao-theme">
                    <h1>Power BI Masterclass: O Motor VertiPaq e o DAX</h1>
                    <p class="subtitle">Entenda o que acontece "por baixo do capô" do Power BI. Domine o Contexto de
                        Avaliação e aprenda a escrever DAX performático.</p>
                </div>

                <!-- CAPÍTULO 1: O MOTOR VERTIPAQ -->
                <section class="content-section">
                    <h2>1. Engenharia: O Motor VertiPaq</h2>
                    <p>Você já se perguntou como o Power BI consegue filtrar 10 milhões de linhas instantaneamente,
                        enquanto o Excel trava com 500 mil? A resposta é o motor <strong>VertiPaq</strong>.</p>

                    <h3>Armazenamento Colunar (Columnar Storage)</h3>
                    <p>O Excel vê uma tabela linha por linha. O Power BI vê coluna por coluna. Se você tem uma coluna
                        "País" com 1 milhão de linhas, mas apenas 5 valores únicos (Brasil, EUA, etc.), o VertiPaq
                        armazena apenas os 5 valores e um "mapa" de onde eles aparecem.</p>

                    <div class="curiosity-box">
                        <h4>💡 O Poder da Compressão</h4>
                        <p>Graças à "Codificação de Dicionário" e "Run-Length Encoding", o Power BI pode comprimir um
                            arquivo de texto de 100MB em um arquivo .pbix de 10MB. <strong>Dica de Ouro:</strong>
                            Colunas com muitos valores únicos (como ID de Transação, Números de Telefone ou Data/Hora
                            exata) matam a compressão. Se não precisar delas para análise, remova-as no Power Query.</p>
                    </div>
                </section>

                <!-- CAPÍTULO 2: CONTEXTOS -->
                <section class="content-section">
                    <h2>2. O Conceito Mais Difícil: C.R.O.W. (Context Rules of World)</h2>
                    <p>Aprender DAX sem entender <strong>Contexto</strong> é como tentar aprender xadrez apenas
                        decorando o nome das peças. O contexto é o tabuleiro.</p>

                    <div class="comparison-grid">
                        <div class="comparison-card">
                            <h4>Contexto de Filtro (Filter Context)</h4>
                            <p>É o "ambiente externo". Imagine que você está olhando para um gráfico de barras filtrado
                                pelo ano "2023".</p>
                            <p>Qualquer fórmula DAX que você escrever ali dentro "sabe" que só pode ver dados de 2023. O
                                contexto de filtro é criado por: Slicers, Clique em gráficos, Linhas de uma matriz,
                                Painel de filtros.</p>
                        </div>
                        <div class="comparison-card">
                            <h4>Contexto de Linha (Row Context)</h4>
                            <p>É o "ambiente interno". Acontece quando você cria uma Coluna Calculada ou usa funções
                                iteradoras (SUMX, FILTER).</p>
                            <p>O DAX olha para a linha atual e diz: "Eu sou o Produto A, custando $10". Ele ignora os
                                filtros externos temporariamente para fazer a conta daquela linha.</p>
                        </div>
                    </div>

                    <div class="pitfall-box">
                        <h4>⚠️ A Transição de Contexto</h4>
                        <p>O maior erro dos iniciantes: tentar usar uma medida dentro de uma coluna calculada sem
                            entender que o <code>CALCULATE</code> transforma Contexto de Linha em Contexto de Filtro. Se
                            você não entender isso, seus totais darão errado e você não saberá por quê.</p>
                    </div>
                </section>

                <!-- CAPÍTULO 3: CALCULATE APROFUNDADO -->
                <section class="content-section">
                    <h2>3. CALCULATE: A Cirurgia no Contexto</h2>
                    <p>A função <code>CALCULATE</code> é a única que tem o poder de modificar o Contexto de Filtro. Ela
                        é o "Deus" do DAX.</p>

                    <h3>Algoritmo de Execução do CALCULATE</h3>
                    <div class="formula-display">
                        CALCULATE (
                        [Total Vendas], <-- 1. A Medida original ALL(Calendario), <-- 2. Remove filtros existentes
                            (ignora o ano selecionado) Calendario[Ano]=2023 <-- 3. Aplica o novo filtro (força ser 2023)
                            ) </div>

                            <p>Quando você arrasta essa medida para um gráfico visualizando 2020, 2021, 2022... a medida
                                mostrará o valor de 2023 para TODOS os anos. Por quê? Porque o CALCULATE ordenou que o
                                filtro original (2020, 2021...) fosse IGNORADO e substituído por 2023.</p>
                </section>

                <!-- CAPÍTULO 4: TIME INTELLIGENCE -->
                <section class="content-section">
                    <h2>4. Inteligência de Tempo (Sem Mágica)</h2>
                    <p>Funções como <code>SAMEPERIODLASTYEAR</code> ou <code>TOTALYTD</code> não são mágicas. Elas são
                        apenas atalhos para um <code>CALCULATE</code> complexo.</p>

                    <div class="case-study-card">
                        <h4>🏢 Case Real: O Calendário Financeiro</h4>
                        <p>Sua empresa fecha o ano fiscal em Março, mas as funções padrão do DAX assumem Dezembro. O que
                            fazer?</p>
                        <p><strong>A Solução:</strong> Entender que <code>TOTALYTD</code> aceita um segundo argumento:
                            <code>"03-31"</code> (fim do ano). Ou melhor, criar sua própria lógica de tempo customizada
                            usando uma Tabela Dcalendario robusta com colunas "AnoFiscal" e "MesFiscal". Analistas
                            Sênior nunca dependem apenas das funções automáticas; eles constroem sua própria lógica de
                            tempo.</p>
                    </div>
                </section>

                <section class="content-section">
                    <h2>5. Desafio de Performance</h2>
                    <p>Você criou uma medida que calcula o ranking de clientes. Porém, ao colocar numa tabela com 1
                        milhão de clientes, o Power BI trava. Onde está o erro?</p>

                    <details class="spoiler-box">
                        <summary>Ver Diagnóstico</summary>
                        <div class="spoiler-content">
                            <p>Provavelmente você está usando <code>RANKX(ALL(Tabela), [Medida])</code>. Isso obriga o
                                Power BI a calcular a medida 1 milhão de vezes na memória.</p>
                            <p><strong>Solução:</strong> Otimização. Verifique se você precisa mesmo mostrar 1 milhão de
                                linhas. Use a técnica de "Top N" para mostrar apenas os 100 primeiros, ou otimize a
                                medida interna para não fazer cálculos desnecessários (ex: usar variáveis
                                <code>VAR</code> para guardar resultados fixos).</p>
                        </div>
                    </details>
                </section>

                <nav class="nav-bottom">
                    <a href="../index.html#visualizacao">[<] Voltar ao Modulo</a>
                            <a href="dashboards-profissionais.html">Proximo: Dashboards Profissionais [>]</a>
                </nav>
    </main>
    <script src="subpage-script.js"></script>
</body>

</html>